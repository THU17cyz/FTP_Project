## FTP大作业文档

2017013599 软件71 从业臻

### UDP部分

需要注意的地方时传输的数据是二进制的，需要编码/解码。server使用一个全局变量记录收到的信息，然后在一个while循环里不断收发，做到响应与收到的消息一一对应即可。

问题回答见相应文件。



### FTP Server部分

使用C在Ubuntu 18.04.2 LTS环境实现了FTP server。请在`server`文件夹下运行`make`，然后运行`./server`，可选参数为`-port`和`-root`，分别是端口号和FTP服务根目录，默认值分别为`21`和`/tmp`。使用较低端口很可能需要管理员权限；且需要确保根目录也有必要的读写权限。

##### 实现指令

- `USER`, `PASS`：用于用户登录
- `TYPE`：设置文件传输模式（只支持二进制模式）

- `SYST`：查看服务器信息

- `QUIT`, `ABOR`：断开连接（`ABOR`采用了只断开数据连接的标准），且`QUIT`返回传输的文件数和字节数
- `POST`, `PASV`：主动/被动传输模式
- `RETR`, `STOR`：下载/上传文件
- `MKD`：创建新目录
- `CWD`, `PWD`：切换/打印当前工作目录
- `RMD`, `DELE`：删除空目录/递归删除任意目录或文件，实现后者是为了便于GUI操作
- `RNFR`, `RNTO`：更改文件名
- `LIST`：返回目录信息
- `REST`：指定文件传输偏移量，实现断点续传

##### 技术重点

- 使用`select`支持**多用户**：使用一个结构体数组管理所有文件描述符，根据`select`选择的读/写文件描述符集合进行多用户管理，并在传输文件时不使用while循环以实现**大文件传输不阻塞**
- 按照正确的顺序进行`connect`/`accept`/`listen`等网络操作
- 使用循环`read`/`write`实现**安全的文件读/写**
- 使用`REST`命令实现**断点续传**；
- 使用`sprintf`, `sscanf`等进行字符串操作
- 使用Linux C目录操作相关函数，结合shell指令，进行目录操作

##### 鲁棒性

本项目对照FTP标准，对各种可能的错误情况有**相应的错误码和错误信息**，使用一个函数统一管理服务端对请求的响应，在网络、文件读写等操作处都有充足的错误处理，保证client的活动不会影响服务器正常运行（比如client强行中断数据连接，服务器能够正确反应），且client产生的错误都有正确的回应。同时为了方便调试，使用`errno`打印出错信息（不过根据文档要求，上交的版本将所有`printf`语句注释了）。



### FTP Client部分

使用Python 3.7， 依托pyqt5框架，实现了在Windows 10环境下运行的FTP client GUI。

##### 实现功能

- 用户登录（将连接与登录封装在一起）
- 设置传输模式/查看服务器信息（在菜单栏）
- 展示服务器的响应，对不同类的响应以不同颜色展示（1开头是蓝，2、3开头是绿，4开头是黄，5开头是红）
- 展示一个目录下的所有内容（包括文件名、文件类型、大小、最后修改时间），初始为根目录，双击文件夹可以进入下一级目录（双击..可以进入上一级目录，出于安全考虑，根目录没有..项，且点击..发送的指令实际上是`CWD`一个客户端记录好的绝对路径，而非`../`）
- 下载选中的文件到指定的文件夹，并显示进度
- 上传指定的文件到**选中**或**当级文件夹**，并显示进度
- 创建新文件夹/删除目录/文件重命名
- 当前进行的下载/上传任务的**暂停**和**恢复**
- 正常退出后，弹出一个窗口展示本次传输了多少文件/字节

##### 技术重点

- 使用`QThread`多线程，实现文件上传/下载时可以暂停
- 结合`CWD`和`LIST`命令实现目录信息的展示
- 使用`REST`命令实现断点续传
- 实现大量错误提示、询问框等

##### 鲁棒性

与server不同，client的错误处理更注重**对用户的友好度**。通过命令的封装（如`USER`后紧跟`PASS`），很多参数、语法错误不会出现；在仍可能发生错误的地方（比如网络），配备了弹出框错误警告的功能。即使server宕机，client也不会崩溃。具体地说，client有如下错误提示/警告/询问：

- 连接登录若失败会提示是什么错误
- server不再运行时，只要进行任意操作或者正在下载/上传文件，都会提示server关闭，然后退出client
- 上传/下载操作，本地文件（夹）选择框若直接关闭则会取消本次操作
- 下载/上传文件时关闭窗口，会弹出选择框让用户选择是否退出，若确定退出则会暂停传输，然后正常退出
- 下载/上传文件时，除了点击暂停或者关闭窗口，其他操作均会有弹出框提示无效
- 下载/上传文件操作，若有重名文件则会询问用户是覆盖还是追加
- 下载/上传文件操作，若用户没有选择任何文件/文件夹，或选择了错误的类型，都会提示
- 下载/上传文件中途暂停传输后将该文件删除，也不会造成崩溃
- 若暂停某次传输后并未恢复，就进行了新的传输，那么恢复键会变为暂停键，也抹去上次传输的记忆
- 暂停上传后会刷新文件的大小
- 任何目录操作，如果无法成功执行，都不会造成client卡死
- 若在进入某个目录时出现问题，会自动切为`PASV`再尝试一次`LIST`（这里是针对vsftpd），若还是有问题则会只显示`..`，使用户可以回退到上一级目录

篇幅限制，文档中就不附带效果展示了。



### 遇到的困难与解决方法

本次作业遇到了不少困难，网络编程实在是一路荆棘。

一个困难是`STOR`和`RETR`命令，标准的实现流程（如连接、发送mark等的相对顺序）描述的不是很清楚，通过使用自动化测试程序和标准客户端，我才确定了实现流程。

select函数功能很强大。不过一开始我了解不够深，对读/写“就绪”状态理解有偏差，导致了一些涉及到传输文件的bug。此外，在实现断点续传时，一些读/写就绪的情况也给我带来了困扰。不过理解了以后就会感觉select还是很方便，不需要考虑进程间通信。

pyqt5的QThread的数个诡异bug卡了我很久。其中一个bug是同样两个信号，一个就是没能触发；另一个bug是在多线程中只要有主线程对象的引用，无论是否使用，都会使程序变得很卡。前一个bug我设法绕过了，后一个采用发送信号的方法避免了主线程对象的引用。

最后，vsftpd有点难配了。网上的教程说法不一，更有一些问题完全找不到解答。比如，PORT命令貌似IP地址必须是127.0.0.1。最终东拼西凑了一份可以匿名成功执行一切除了PORT指令的配置。不过回头看来，踩坑主要的原因还是对Linux不熟悉（尤其是权限），现在就感觉对Linux的认识上升了一层。



### 感想与收获

以前对网络编程几乎没有概念，因此这次作业一开始做得挺艰难的。当然，收获是非常大的，现在对python, C/C++怎么网络编程至少有了概念和一定的实战经验，也了解了FTP协议的很多内容。学会简单地使用pyqt5也算一个收获。

另一个巨大的收获是对Linux的文件描述符、文件操作、权限等都有更深刻的认识，感受到了Linux的“一切皆文件”思想。